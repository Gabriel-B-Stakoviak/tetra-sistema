{% extends "internal-base/base-dash.html" %}
{% load static %}

{% block title %}Dashboard{% endblock title %}

{% block title-page %}Dashboard{% endblock title-page %}

{% block content %}
<!-- Dashboard com 3 blocos de turnos -->
<div class="container-fluid px-0">
    <!-- Blocos de Produção por Turno -->
    <div class="row g-4 justify-content-center px-3">
        <!-- Turno 1 -->
        <div class="col-lg-3 col-md-6">
            <div class="card h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #4a5568, #2d3748);">
                <div class="card-body text-white">
                    <div class="text-center">
                        <h5 class="card-title mb-2">Turno A</h5>
                        <hr style="border-color: rgba(255,255,255,0.3); margin: 0 0 15px 0;">
                        <h6 class="mb-2">Fardos: {{ turno1_total }}</h6>
                        <h6 class="mb-0">Reversões: {{ turno1_reversao }}</h6>
                    </div>
                </div>
            </div>
        </div>

        <!-- Turno 2 -->
        <div class="col-lg-3 col-md-6">
            <div class="card h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #744210, #553c0f);">
                <div class="card-body text-white">
                    <div class="text-center">
                        <h5 class="card-title mb-2">Turno B</h5>
                        <hr style="border-color: rgba(255,255,255,0.3); margin: 0 0 15px 0;">
                        <h6 class="mb-2">Fardos: {{ turno2_total }}</h6>
                        <h6 class="mb-0">Reversões: {{ turno2_reversao }}</h6>
                    </div>
                </div>
            </div>
        </div>

        <!-- Turno 3 -->
        <div class="col-lg-3 col-md-6">
            <div class="card h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #1a365d, #2c5282);">
                <div class="card-body text-white">
                    <div class="text-center">
                        <h5 class="card-title mb-2">Turno C</h5>
                        <hr style="border-color: rgba(255,255,255,0.3); margin: 0 0 15px 0;">
                        <h6 class="mb-2">Fardos: {{ turno3_total }}</h6>
                        <h6 class="mb-0">Reversões: {{ turno3_reversao }}</h6>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bloco Total Geral -->
        <div class="col-lg-3 col-md-6">
            <div class="card h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #22543d, #2f855a);">
                <div class="card-body text-white">
                    <div class="text-center">
                        <h5 class="card-title mb-2">Total Geral</h5>
                        <hr style="border-color: rgba(255,255,255,0.3); margin: 0 0 15px 0;">
                        <h6 class="mb-2">Fardos: {{ total_geral_fardos }}</h6>
                        <h6 class="mb-0">Reversões: {{ total_geral_reversao }}</h6>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela Simples - Largura Total -->
    <div class="row mt-2">
        <div class="col-12 px-0">
            <div class="card shadow-sm mx-0" style="border-radius: 0;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-truck-loading me-2"></i>
                        Carregamentos Recentes
                    </h5>
                </div>
                <div class="card-body p-0" style="height: 190px; overflow-y: auto;">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th scope="col">Data</th>
                                    <th scope="col">Empresa</th>
                                    <th scope="col">Material</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for carregamento in carregamentos %}
                                    <tr>
                                        <td>
                                            <i class="fas fa-calendar me-1"></i>
                                            {{ carregamento.data_criacao|date:"d/m/Y" }}
                                        </td>
                                        <td>
                                            <i class="fas fa-building me-1"></i>
                                            {{ carregamento.empresa.nome }}
                                        </td>
                                        <td>
                                            <i class="fas fa-box me-1"></i>
                                            {{ carregamento.material }}
                                        </td>
                                        <td>
                                            {% if carregamento.status == 'pendente' %}
                                                <span class="badge bg-warning text-dark">
                                                    <i class="fas fa-clock me-1"></i>
                                                    Pendente
                                                </span>
                                            {% elif carregamento.status == 'concluido' %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check me-1"></i>
                                                    Carregado
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary">
                                                    {{ carregamento.get_status_display }}
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if carregamento.status == 'pendente' %}
                                                <button type="button" 
                                                        class="btn btn-sm btn-success" 
                                                        onclick="marcarCarregado({{ carregamento.id }})">
                                                    <i class="fas fa-check me-1"></i>
                                                    Carregado
                                                </button>
                                            {% elif carregamento.status == 'concluido' %}
                                                <span class="text-muted">
                                                    <i class="fas fa-check-circle me-1"></i>
                                                    Concluído
                                                </span>
                                            {% else %}
                                                <span class="text-muted">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    {{ carregamento.get_status_display }}
                                                </span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-4">
                                            <i class="fas fa-inbox fa-2x mb-2"></i>
                                            <br>
                                            Nenhum carregamento registrado ainda.
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bloco de Texto Vertical -->
    <div class="row mt-2 mx-0">
        <div class="col-12 px-0">
            <div class="card shadow-sm mx-0" style="border-radius: 0;">
                <div class="card-body p-4">
                    <!-- Primeiro Título e Parágrafo -->
                    <h6 class="text-primary mb-2">Primeiro Título</h6>
                    <p class="text-muted mb-3" style="font-size: 0.8rem;">
                        Lorem ipsum dolor sit amet, magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                    </p>

                    <!-- Segundo Título e Parágrafo -->
                    <h6 class="text-success mb-2">Segundo Título</h6>
                    <p class="text-muted mb-3" style="font-size: 0.8rem;">
                        Totam rem aperiam,  aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem sequi nesciunt. Neque porro quisquam est, qui dolorem ipsum quia dolor sit amet, consectetur, adipisci velit.
                    </p>

                    <!-- Terceiro Título e Parágrafo -->
                    <h6 class="text-info mb-2">Terceiro Título</h6>
                    <p class="text-muted mb-0" style="font-size: 0.8rem;">
                        Ut enim ad minima veniam, nisi ut aliquid ex ea commodi consequatur? Quis autem vel eum iure reprehenderit qui in ea voluptate velit esse quam nihil molestiae consequatur. Vel illum qui dolorem eum fugiat quo voluptas nulla pariatur? At vero eos et accusamus et iusto odio dignissimos ducimus.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

</div>

<script>
function marcarCarregado(carregamentoId) {
    if (!confirm('Marcar como carregado?')) {
        return;
    }
    
    // Obter o token CSRF
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                     document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
                     getCookie('csrftoken');
    
    // Fazer requisição POST
    fetch(`/marcar-carregamento-concluido/${carregamentoId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Recarregar a página para mostrar as mudanças
            location.reload();
        } else {
            alert('Erro: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao marcar carregamento como concluído');
    });
}

// Função para obter cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% endblock content %}